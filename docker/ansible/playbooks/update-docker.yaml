---
- hosts: all
  become: yes
  vars:
    # Directories
    templates_src_path: "../templates/data/{{inventory_hostname_short}}"
    templates_dest_path: "/srv/docker/data"
  tasks:

    - include_tasks: ../tasks/ufw.yml

    - name: Load encrypted credentials
      community.sops.load_vars:
        file: ../inventory/group_vars/all/secrets.sops.yml
        age_keyfile: $HOME/git/home/age.key
        config_path: $HOME/git/home/.sops.yaml
        expressions: ignore  # explicitly do not evaluate expressions
                             # on load (this is the default)

    - name: Write docker-compose configuration file
      copy:
        src: "../templates/docker-compose/{{inventory_hostname_short}}.yml"
        dest: "/srv/docker/docker-compose.yml"
        owner: "{{ansible_user}}"
        group: "docker"
        mode: "0755"

    - name: Dynamically create .env file
      ansible.builtin.template:
        src: "../templates/env/env.j2"
        dest: "/srv/docker/.env"
        owner: "{{ansible_user}}"
        group: "docker"
        mode: "0755"

    - name: Copy all data directories recursively
      file: dest={{templates_dest_path}}/{{ item|replace(templates_src_path+'/', '') }} state=directory owner={{ansible_user}} group=docker mode=0755
      with_items: "{{ lookup('pipe', 'find '+ templates_src_path +'/ -type d').split('\n') }}"

    - name: Copy all data files recursively
      copy: src={{ item }} dest={{templates_dest_path}}/{{ item|replace(templates_src_path+'/', '') }}  owner={{ansible_user}} group=docker mode=0755
      with_items: "{{ lookup('pipe', 'find '+ templates_src_path +'/ -type f -not -name *.j2 ').split('\n') }}"

    - name: Copy data templates files recursively
      template: src={{ item }} dest={{templates_dest_path}}/{{ item|replace(templates_src_path+'/', '')|replace('.j2', '') }}  owner={{ansible_user}} group=docker mode=0755
      with_items: "{{ lookup('pipe', 'find '+ templates_src_path +'/ -type f -name *.j2').split('\n') }}"

    - name: Copy compose-modules folder
      copy:
        src: "../templates/compose-modules/"
        dest: "/srv/docker/data/compose"
        owner: "{{ansible_user}}"
        group: "docker"
        mode: "0755"

    - name: Run containers
      shell:
        cmd: "docker compose up -d --remove-orphans"
        chdir: /srv/docker

  handlers:
    - import_tasks: ../handlers/main.yml
