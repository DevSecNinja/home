services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:v0.6.30@sha256:b9f7930a5eea6a3284f45ab6d20f9e1e02a5cd6da6b57b962b05422de5233f23
    container_name: open-webui
    depends_on:
      - traefik
    restart: always
    security_opt:
      - no-new-privileges=true
    mem_limit: 1024m
    volumes:
      - open_webui_data:/app/backend/data
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - ENABLE_OAUTH_SIGNUP=true
      - WEBUI_AUTH_TRUSTED_EMAIL_HEADER=x-forwarded-user
      - WEBUI_AUTH_TRUSTED_NAME_HEADER=x-forwarded-displayname
      - WEBUI_URL=https://chat.$DOMAINNAME
      - WEBUI_SECRET_KEY=${OPEN_WEBUI_SECRET_KEY}
      - ENABLE_LOGIN_FORM=true # Required for OAuth to work. Otherwise you'll get a strange error
      - ENABLE_OPENAI_API=true
      - ENABLE_EVALUATION_ARENA_MODELS=false

      # TODO: [open-webui] Fix adding OpenAI and Ollama API keys. Somehow getting error 500
      # NOTE: Specifying multiple keys & base URLs doesn't seem to work yet and results in a 500 error
      # Keeping the variable name as KEYS and URLS for future compatibility
      - OPENAI_API_KEY=${OPEN_WEBUI_AZURE_API_KEYS}
      - OPENAI_API_BASE_URL=${OPEN_WEBUI_AZURE_API_URLS}
      # NOTE: Add once the URL is live. Open WebUI will slow down a lot when this URL isn't available
      #- OLLAMA_BASE_URL=${OPEN_WEBUI_OLLAMA_BASE_URL}

      # TODO: [open-webui] Fix manual task: To be added when implemented by Open WebUI
      # ${OPEN_WEBUI_AZURE_API_PREFIX_IDS}
      # ${OPEN_WEBUI_AZURE_API_VERSIONS}
      # ${OPEN_WEBUI_AZURE_API_TAGS}
      # ${OPEN_WEBUI_AZURE_API_MODEL_IDS}
    networks:
      - open-webui-frontend
    labels:
      # Homepage
      - homepage.group=Productivity
      - homepage.name=Open WebUI
      - homepage.icon=open-webui.svg
      - homepage.href=https://chat.$DOMAINNAME
      - homepage.description=Your ChatGPT in the Browser
      # Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=open-webui-frontend"
      ## Middlewares
      - "traefik.http.routers.open-webui-rtr.middlewares=chain-auth@file"
      ## HTTP Services
      - "traefik.http.routers.open-webui-rtr.rule=Host(`chat.$DOMAINNAME`)"
      - "traefik.http.routers.open-webui-rtr.service=open-webui"
      # Enable the management port
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"

networks:
  open-webui-frontend:
    name: open-webui-frontend

volumes:
  open_webui_data:
