services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:v0.6.18@sha256:ff87dd7605720f33411d87ed5550357b665cec4880378176f2f95bfe751f5e32
    container_name: open-webui
    depends_on:
      - traefik
    restart: always
    security_opt:
      - no-new-privileges=true
    mem_limit: 1024m
    volumes:
      - open_webui_data:/app/backend/data
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - ENABLE_OAUTH_SIGNUP=true
      - WEBUI_AUTH_TRUSTED_EMAIL_HEADER=x-forwarded-user
      # - WEBUI_AUTH_TRUSTED_NAME_HEADER= # TODO: [open-webui] Add Display Name from header
      - WEBUI_URL=https://chat.$DOMAINNAME
      - WEBUI_SECRET_KEY=${OPEN_WEBUI_SECRET_KEY}
      - ENABLE_LOGIN_FORM=true # Required for OAuth to work. Otherwise you'll get a strange error
      - ENABLE_OPENAI_API=true
      - OPENAI_API_KEY=${OPEN_WEBUI_AZURE_API_KEYS}
      - OPENAI_API_BASE_URL=${OPEN_WEBUI_AZURE_API_URLS}
      - OLLAMA_BASE_URL=${OPEN_WEBUI_OLLAMA_BASE_URL}
      # TODO: [open-webui] Fix manual task: To be added when implemented by Open WebUI
      # ${OPEN_WEBUI_AZURE_API_PREFIX_IDS}
      # ${OPEN_WEBUI_AZURE_API_VERSIONS}
      # ${OPEN_WEBUI_AZURE_API_TAGS}
      # ${OPEN_WEBUI_AZURE_API_MODEL_IDS}
    networks:
      - open-webui-frontend
    labels:
      # Homepage
      - homepage.group=Productivity
      - homepage.name=Open WebUI
      - homepage.icon=open-webui.svg
      - homepage.href=https://chat.$DOMAINNAME
      - homepage.description=Your ChatGPT in the Browser
      # Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=open-webui-frontend"
      ## Middlewares
      - "traefik.http.routers.open-webui-rtr.middlewares=chain-auth@file"
      ## HTTP Services
      - "traefik.http.routers.open-webui-rtr.rule=Host(`chat.$DOMAINNAME`)"
      - "traefik.http.routers.open-webui-rtr.service=open-webui"
      # Enable the management port
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"

networks:
  open-webui-frontend:
    name: open-webui-frontend

volumes:
  open_webui_data:
