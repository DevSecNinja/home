services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:v0.6.18@sha256:ff87dd7605720f33411d87ed5550357b665cec4880378176f2f95bfe751f5e32
    container_name: open-webui
    depends_on:
      - traefik
    restart: always
    security_opt:
      - no-new-privileges=true
    mem_limit: 1024m
    environment:
      - PUID=${PUID}
      - PGID=${PGID}
      - TZ=${TZ}
      - ENABLE_OAUTH_SIGNUP=true
      - WEBUI_AUTH_TRUSTED_EMAIL_HEADER=x-forwarded-user
      # - WEBUI_AUTH_TRUSTED_NAME_HEADER= # TODO: [open-webui] Add Display Name from header
      - WEBUI_URL=https://chat.$DOMAINNAME
      - ENABLE_LOGIN_FORM=false
      - ENABLE_OPENAI_API=true
      - OPENAI_API_KEY=${LOBE_CHAT_AZURE_API_KEY}
      - OPENAI_API_BASE_URL=${LOBE_CHAT_AZURE_ENDPOINT}
    networks:
      - open-webui-frontend
    labels:
      # Homepage
      - homepage.group=Productivity
      - homepage.name=Open WebUI
      - homepage.icon=openwebui.svg
      - homepage.href=https://chat.$DOMAINNAME
      - homepage.description=Your ChatGPT in the Browser
      # Traefik
      - "traefik.enable=true"
      - "traefik.docker.network=open-webui-frontend"
      ## Middlewares
      - "traefik.http.routers.open-webui-rtr.middlewares=chain-auth@file"
      ## HTTP Services
      - "traefik.http.routers.open-webui-rtr.rule=Host(`chat.$DOMAINNAME`)"
      - "traefik.http.routers.open-webui-rtr.service=open-webui"
      # Enable the management port
      - "traefik.http.services.open-webui.loadbalancer.server.port=3210"

networks:
  open-webui-frontend:
    name: open-webui-frontend
