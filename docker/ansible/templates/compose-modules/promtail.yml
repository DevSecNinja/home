services:
  promtail:
    image: grafana/promtail:3.0.0@sha256:43c497a102e333c30b7c0f9a45d9107151f6424bd40c424d96791e65b6f2aeb0
    container_name: promtail
    depends_on:
      - loki
      - promtail-docker-proxy
    volumes:
      - $DOCKERDIR/data/promtail/promtail.yml:/etc/promtail/promtail.yml
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - TZ=${TZ}
    command: -config.file=/etc/promtail/promtail.yml
    restart: always
    networks:
      - t2_proxy
      - promtail-backend
    mem_limit: 1024m
    security_opt:
      - no-new-privileges=true
    labels:
      # Homepage
      - homepage.group=Infrastructure
      - homepage.name=Promtail
      - homepage.icon=grafana.svg
      - homepage.href=https://promtail.$DOMAINNAME
      - homepage.description=Log Collector
      # Group
      - org.label-schema.group=infrastructure
      # Traefik
      - "traefik.enable=true"
      ## Middlewares
      - "traefik.http.routers.promtail-rtr.middlewares=chain-auth@file"
      ## HTTP Services
      - "traefik.http.routers.promtail-rtr.service=promtail"
      ### Enable the server port
      - "traefik.http.services.promtail.loadbalancer.server.port=9080"

  promtail-docker-proxy:
    image: lscr.io/linuxserver/socket-proxy:1.24.0@sha256:5095b08491874c14dd3463b5d2a452a5a2ec2244cc71687a71994e6780d6839c
    container_name: promtail-docker-proxy
    restart: always
    networks:
      - promtail-backend
    environment:
      - TZ=${TZ}
      - NODES=1
      - NETWORKS=1
      - SERVICES=1
      - TASKS=1
    security_opt:
      - no-new-privileges=true
    mem_limit: 50m
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    read_only: true
    tmpfs:
      - /run

networks:
  promtail-backend:
    name: promtail-backend
    driver: bridge
